# Pragmatic File Declutter

## WHAT
Desktop application (Windows) for automated photo and file organization using AI.
Built with Python + NiceGUI (native desktop look via pywebview).

**Current version target:** v0.1.0 (scan + deduplication)

## WHY
Users accumulate thousands of disorganized photos across devices. Manual sorting is tedious and error-prone. This tool automates the heavy lifting: finding duplicates, classifying content, and grouping by events â€” all without ever deleting a single file.

## HOW

### Tech Stack
- **Language:** Python 3.11+
- **UI Framework:** NiceGUI with `native=True` (pywebview) â€” looks like a desktop app, not a browser
- **ML/AI Local:** open-clip-torch (CLIP ViT-B/32) on CUDA (RTX 3050)
- **ML/AI Cloud:** Gemini 2.0 Flash (primary), GPT-4o mini (fallback)
- **Hashing:** imagehash (phash + dhash)
- **Clustering:** HDBSCAN
- **Packaging:** Nuitka (Python â†’ C â†’ .exe)
- **Auto-update:** tufup
- **Versioning:** SemVer via Commitizen

### Architecture
```
src/pragmatic_file_declutter/
â”œâ”€â”€ core/          # Business logic (scanner, dedup, classifier, clusterer, etc.)
â”œâ”€â”€ ui/            # NiceGUI pages and components
â”‚   â”œâ”€â”€ pages/     # Full page views
â”‚   â””â”€â”€ components/ # Reusable UI components
â””â”€â”€ services/      # External APIs, updater, cost estimator
```

**Pluggable scanner architecture:** `core/` is decoupled from data sources.
v1 reads from local filesystem. Future versions add Android backup (v2), cloud (v3).

### Pipeline (3 Steps)
1. **Deduplicate** â†’ Perceptual hash (phash+dhash). Hamming distance 0-5 = identical, 6-10 = similar
2. **Classify** â†’ Heuristics â†’ CLIP local â†’ Gemini API â†’ GPT fallback. Categories: screenshots, documents, receipts, random
3. **Organize by Event** â†’ Temporal-first clustering (EXIF date, 48h gap = new event) â†’ Visual refinement via CLIP embeddings â†’ HDBSCAN

### Output Folder Structure
```
[user_selected_folder]/_pragmatic_declutter/
â”œâ”€â”€ duplicadas/
â”‚   â”œâ”€â”€ identicas/
â”‚   â”œâ”€â”€ similares/
â”‚   â””â”€â”€ apagar/        # User-confirmed duplicates to delete
â”œâ”€â”€ misc/
â”‚   â”œâ”€â”€ screenshots/
â”‚   â”œâ”€â”€ documents/
â”‚   â”œâ”€â”€ receipts/
â”‚   â””â”€â”€ random/
â”œâ”€â”€ organize/
â”‚   â””â”€â”€ [Event_Name_Date]/
â”œâ”€â”€ videos/
â”œâ”€â”€ corrupted/
â”œâ”€â”€ no_metadata/
â””â”€â”€ _reports/
```

## CRITICAL RULES

### ðŸš¨ NEVER DELETE FILES
- The ONLY allowed file operation is `shutil.move()`
- NEVER use `os.remove()`, `os.unlink()`, `shutil.rmtree()`, `pathlib.Path.unlink()`
- NEVER use `shutil.copy()` or `shutil.copy2()` â€” only MOVE
- Every move operation MUST be logged to an undo stack
- Before ANY file operation, verify source exists AND destination doesn't

### Code Quality
- Type hints on ALL functions (enforced by mypy strict)
- Docstrings on all public functions (Google style)
- Tests for all core/ modules (pytest, >80% coverage target)
- Ruff for linting and formatting (line length 120)

### Git Conventions
- **Commits:** Conventional Commits via Commitizen (`feat:`, `fix:`, `docs:`, `refactor:`, `test:`, `chore:`)
- **Branches:** GitHub Flow â€” `main` + `feature/xxx` branches
- **Versioning:** SemVer (MAJOR.MINOR.PATCH)
- **CHANGELOG:** Auto-generated by Commitizen

### Dependencies
When adding new dependencies:
1. Add to `pyproject.toml` under appropriate group
2. Pin major version only (e.g., `nicegui>=2.0,<3.0`)
3. Document WHY in the PR/commit message

## REFERENCE FILES
- `docs/KNOWLEDGE_BASE.md` â€” Complete research, decisions, trade-offs, pricing
- `.claude/agents/` â€” Specialized subagents for different tasks
- `.claude/commands/` â€” Custom slash commands

## HARDWARE CONTEXT
- **User machine:** 16GB RAM, NVIDIA RTX 3050 (CUDA capable)
- **Photo volume:** ~10,000 photos initially, hundreds per month ongoing
- **Supported formats:** JPEG, PNG, WebP, HEIC (pillow-heif), RAW (rawpy), TIFF, BMP, GIF

## PRODUCT ROADMAP
- **v0.1.0** â€” Scan + Deduplication (current target)
- **v0.2.0** â€” Classification (screenshots, documents, receipts)
- **v0.3.0** â€” Event clustering + timeline
- **v0.4.0** â€” Search (CLIP textâ†’image)
- **v1.0.0** â€” Full photo declutter with polish
- **v2.0.0** â€” General file declutter
- **v3.0.0** â€” Android backup connect
- **v4.0.0** â€” Cloud sync (Google Photos, iCloud)

## CONFIDENCE SCORING
- **High (>85%):** Auto-move, show in results
- **Medium (50-85%):** Human review queue
- **Low (<50%):** Move to `random/` folder

## API COST MANAGEMENT
- Always show cost estimation BEFORE making API calls
- Show both Gemini and GPT quotes side by side
- Estimated cost: ~$0.001/photo (Gemini), ~$0.002/photo (GPT)
- ~$1.10 for 10,000 photos with hybrid pipeline (90% CLIP local)

## FEATURE FLAGS
- Located at `src/pragmatic_file_declutter/core/feature_flags.py`
- JSON-based, local file (`~/.pragmatic-declutter/flags.json`)
- Use for incremental feature rollout
